= Authenticate users with an identity provider
:page-sidebar: am_3_x_sidebar
:page-permalink: am/current/am_quickstart_authenticate_users.html
:page-folder: am/quickstart
:page-layout: am

== Create a security domain

A _security domain_ is a series of security policies that apply to a set of applications which all share common security mechanisms for authentication, authorization and identity management.

NOTE: If you already have a security domain, you can skip this part.

. Log in to http://GRAVITEEIO-AM-UI-HOST. Note that the default Administrator account is *admin/adminadmin*.
. From the user menu at the top right, click *Create domain*.
. Give your security domain a *Name* and a *Description* and click *CREATE*.
. Enable your domain by clicking on the banner *click here* link.

[source]
----
# create domain
curl -H "Authorization: Bearer :accessToken" \
     -H "Content-Type:application/json;charset=UTF-8" \
     -X POST \
     -d '{"name":"My First Security Domain","description":"My First Security Domain description"}' \
     http://GRAVITEEIO-AM-MGT-API-HOST/management/organizations/DEFAULT/environments/DEFAULT/domains


# enable domain
curl -H "Authorization: Bearer :accessToken" \
     -H "Content-Type:application/json;charset=UTF-8" \
     -X PATCH \
     -d '{"enabled": true}' \
     http://GRAVITEEIO-AM-MGT-API-HOST/management/organizations/DEFAULT/environments/DEFAULT/domains/:domainId
----

== Create an application

Before you can work with AM Gateway, you must create an application.
The application will provide the necessary information (such as the client ID and client Secret) for authentication and authorization.
The application can be a native mobile app, a single page front-end web app or a regular web app that executes on a server.

Create your application as follows:

. Click *Applications*.
. In the Applications page, click the plus icon image:icons/plus-icon.png[].
. Choose *Backend to Backend* application type.
. Click the *Next* button.
. Give your application a *Name* and a *Redirect URI* (with https scheme and non localhost) and click the *Create* button.

NOTE: This application will be used by end users, so we need to bind them with identity providers.

== Create an identity provider

An _identity provider_ is usually a service used to authenticate and communicate authorization and user information.
It can be a social provider like Facebook, Google or Twitter, an enterprise provider such as Active Directory or a custom provider such as a database.

NOTE: In this example, we will create an In-memory identity provider with an inline user configuration.

. Click *Settings > Providers*.
. In the Identity Providers page, click the plus icon image:icons/plus-icon.png[].
. Choose *Inline* and click *Next*.
+
image::am/current/graviteeio-am-quickstart-idp-type.png[]

. Give your identity provider a *Name* and enter the user details, then click *Create*.
+
image::am/current/graviteeio-am-quickstart-create-idp.png[]
+
[source]
----
curl -H "Authorization: Bearer :accessToken" \
     -H "Content-Type:application/json;charset=UTF-8" \
     -X POST \
     -d '{
           "external": false,
           "type": "inline-am-idp",
           "configuration": "{\"users\":[{\"firstname\":\"John\",\"lastname\":\"Doe\",\"username\":\"johndoe\",\"password\":\"johndoepassword\"}]}",
           "name": "Inline IdP"
         }' \
     http://GRAVITEEIO-AM-MGT-API-HOST/management/organizations/DEFAULT/environments/DEFAULT/domains/:securityDomainPath/identities
----

. Go back to your web application.
. In the *Identity Providers* tab, select *Inline identity provider* and click *SAVE*.
+
image::am/current/graviteeio-am-quickstart-client-idp.png[]

Your web application is now completely set up.

== Test your identity provider with OAuth2

NOTE: In this example, we will use the link:https://tools.ietf.org/html/rfc6749#section-1.3.3[Resource Owner Password Credentials flow^]. The default flow must be the link:https://tools.ietf.org/html/rfc6749#section-1.3.1[Authorization Code flow^] with a login page displayed to the end user.

OAuth 2 is an authorization framework that allows applications acting on behalf of the end user to obtain limited access to HTTP services.
link:https://tools.ietf.org/html/rfc6749[OAuth 2 RFC^] defines two endpoints:

- The *authorization endpoint* used to interact with the resource owner and obtain an authorization grant via user-agent redirection.
- The *token endpoint* used by the client to obtain an access token by presenting its authorization grant.

NOTE: For further information about OAuth2, view the link:https://tools.ietf.org/html/rfc6749[RFC page^].

In order to validate the identity provider configuration, we will request an access token.

Request a token::

[source]
----
curl -X POST \
  'http://GRAVITEEIO-AM-GATEWAY-HOST/:domainPath/oauth/token \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -H 'Authorization: Basic Base64.encode64(:clientId + ':' + :clientSecret)' \
  -d 'grant_type=passsword' \
  -d 'username=:username' \
  -d 'password=:passsword'
----

[width="100%",cols="2,8",frame="topbot",options="header,footer"]
|==========================
|Parameter       |Description
|grant_type      |*REQUIRED.* Set the value to `password`.
|client_id       |*REQUIRED.* Client's ID. (Basic Auth)
|client_secret   |*REQUIRED.* Client's secret. (Basic Auth)
|username        |*REQUIRED.* User's name.
|password        |*REQUIRED.* User's password.
|scope           |*OPTIONAL.* The scopes of the access token.
|==========================

If it works correctly, you will see the following response:

[source]
----
HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
{
    "access_token" : "eyJraWQiOiJkZWZhdWx0LWdyYXZpdGVlLUFNLWtleSIsImFsZyI6IkhTMjU2In0.eyJzdWIiOiI0NTM...QW5rN0h2SEdUOFNMYyJ9.w8A9yKJcuFbE_SYmRRAdGBEz-6nnXg7rdv1S4JD9xGI",
    "token_type": "bearer",
    "expires_in": 7199
}
----
