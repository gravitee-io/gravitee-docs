= JWT Bearer
:page-sidebar: am_3_x_sidebar
:page-permalink: am/current/am_userguide_extension_grants_jwt_bearer.html
:page-folder: am/user-guide
:page-layout: am

AM supports the link:https://tools.ietf.org/html/rfc7523[RFC 7523^] specification, which defines the
use of a JSON Web Token (JWT) Bearer Token as a means for requesting an OAuth 2.0 access token and for client
authentication. The JWT Bearer Token flow supports the RSA SHA256 algorithm, which uses a public key as the
signing secret.

JWT bearer tokens can be used for secure communication between devices and services (and applications) running in
the cloud which are protected using OAuth2. Devices is a broad term used for devices, clients, machines and
third-party applications that may or may not be web-based.

== Generate the key pair

[source,shell]
....
// Generate the private key
$ openssl genpkey -algorithm RSA -out rsa_private.pem -pkeyopt rsa_keygen_bits:2048

// Generate the public key
$ openssl rsa -in rsa_private.pem -pubout -out rsa_public.pem
....

== Create a new JWT bearer extension grant

. link:{{ '/am/current/am_userguide_authentication.html' | relative_url }}[Log in to AM Console^].
. Click *Settings*, then in the *OAUTH 2.0* section, click *Extension Grants*.
. Click the plus icon image:{% link images/icons/plus-icon.png %}[role="icon"].
+
image::{% link images/am/current/graviteeio-am-userguide-extension-grants-jwt-bearer-create1.png %}[]
. Select *Extension Grant JWT Bearer* and click *Next*.
+
image::{% link images/am/current/graviteeio-am-userguide-extension-grants-jwt-bearer-create2.png %}[]
+
. Complete the grant flow configuration and click *Create*.
+
[NOTE]
====
In order to validate the signature of the incoming token, you need to provide a public key in format:

`SSH public key (ssh-(rsa|dsa) ([A-Za-z0-9/+]+=*) (.*))`.

If you have an existing public key in `pem` format, you can use the following command line to obtain the PKCS#8:

[source,shell]
....
$ ssh-keygen -i -m PKCS8 -f rsa_public.pem
....

image::{% link images/am/current/graviteeio-am-userguide-extension-grants-jwt-bearer-create3.png %}[]

If you want to copy claims from the incoming token to the final access token, you can use the *Claims mapper*.
The *Claims mapper* will copy the incoming token claims as additional information about the user profile under the `claims` entry. This will allow you to add these claims using token customization.
====

== Associate the extension grant with an application

. In AM Console, click *Applications*.
. Select your application and in the *Settings* tab, click *OAuth 2.0 / OIDC*.
. In the *Grant flows* section, select your extension grant.
+
image::{% link images/am/current/graviteeio-am-userguide-extension-grants-jwt-bearer-associate.png %}[]
+
. Click *SAVE*.
+
You are now ready to use AM Gateway to exchange a token generated by a third party for an AM token.

== Token exchange

This example assumes the token is in the following format:

[source,shell]
....
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.eC6XIImo6WMhm2oQXksgYN6iRMWmE3aQwPYabM3iUICojEhtPZn9Ifk7KZMPFUa78Ijl42YWEBG0Z_hr7yuQy9YHcT1tEkkG2OGKBr5x_BwiWVwZvYaQA-dP08wriXOqEx-v-xB-z6qHOS8lpo_d6LvYrTXkslCaX1A3HZMT2-MQjmJvVUDQM6wID_5L-XiJuSEk36fx-f7TuCWfzPXgrRgCG5sg2vv74sn-HGUVUMZlTwBxvj_itxYuu-M5L5l7YSkNITPaPgK4TD4qwOCOfYKKpKEe4RV0GDrV_Sf7_Ps1qextkpGtRztr90fsuooQKaJSVaE_d7BDEpkLe7Ss7w
....

With the following content:

[source,json]
....
// header
{
  "alg": "RS256",
  "typ": "JWT"
}

// data
{
  "sub": "1234567890",
  "name": "John Doe",
  "admin": true,
  "iat": 1516239022
}
....

To exchange the token, you need to call AM Gateway with the following parameter definitions:

* `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer`
* `assertion=#jwt_token`

Here is an example using `curl`:

[source,shell]
....
$ curl -X POST http://localhost:8092/fapi/oauth/token -H 'Authorization: basic base64(client_id:client_secret)' -d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.eC6XIImo6WMhm2oQXksgYN6iRMWmE3aQwPYabM3iUICojEhtPZn9Ifk7KZMPFUa78Ijl42YWEBG0Z_hr7yuQy9YHcT1tEkkG2OGKBr5x_BwiWVwZvYaQA-dP08wriXOqEx-v-xB-z6qHOS8lpo_d6LvYrTXkslCaX1A3HZMT2-MQjmJvVUDQM6wID_5L-XiJuSEk36fx-f7TuCWfzPXgrRgCG5sg2vv74sn-HGUVUMZlTwBxvj_itxYuu-M5L5l7YSkNITPaPgK4TD4qwOCOfYKKpKEe4RV0GDrV_Sf7_Ps1qextkpGtRztr90fsuooQKaJSVaE_d7BDEpkLe7Ss7w"
....

[source,json]
....
{
"access_token" : "eyJraWQiOiJkZWZhdWx0LWdyYXZpdGVlLUFNLWtleSIsImFsZyI6IkhTMjU2In0.eyJzdWIiOiIxMjM0NTY3ODkwIiwiYXVkIjoiMTFkYWQ4MGUtYTk0MC00YWFlLTlhZDgtMGVhOTQwMGFhZTYwIiwiZG9tYWluIjoiZmFwaSIsImlzcyI6Imh0dHA6XC9cL2xvY2FsaG9zdDo4MDkyXC9mYXBpXC9vaWRjIiwiZXhwIjoxNTk2NDk4NTA5LCJpYXQiOjE1OTY0OTEzMDksImp0aSI6IlI5V25oR2lPRGppTmc2aGNvNHRhb2NIcXVmZmx2cWYwQ2dlampQcnZvcnMifQ.SYls19XDhFG3UuPNFMWOA-F1Dtc_1_v4FtqFU0Evnss",
"token_type" : "bearer",
"expires_in" : 7199
}
....

As we can see, we now have an AM-managed access token:

[source,json]
....
// header
{
  "kid": "default-gravitee-AM-key",
  "alg": "HS256"
}

// data
{
  "sub": "1234567890",
  "aud": "11dad80e-a940-4aae-9ad8-0ea9400aae60",
  "domain": "fapi",
  "iss": "http://localhost:8092/fapi/oidc",
  "exp": 1596498509,
  "iat": 1596491309,
  "jti": "R9WnhGiODjiNg6hco4taocHqufflvqf0CgejjPrvors"
}
....
